<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; background: #222; color: #fff; text-align: center; }
    .box { padding: 20px; background: #444; margin: 20px auto; max-width: 400px; border-radius: 10px; }
    .active { background: #00AA00 !important; }
    td { padding: 5px 10px; text-align: left; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 400px; margin: 0 auto; }
    .btn { background: #555; padding: 10px; border-radius: 5px; font-size: 10px; text-transform: uppercase; }
    .pressed { background: #00FF00 !important; color: #000; font-weight: bold; }
  </style>
</head>
<body>
  <!-- Python injects the SSID here -->
  <h1>{{ssid}}</h1>
  <div id="status" class="box">Connect Controller + Press Button</div>
  
  <div class="box">
    <table style="margin: 0 auto;">
      <tr><td>LX: <span id="lx">0</span></td><td>RX: <span id="rx">0</span></td></tr>
      <tr><td>LY: <span id="ly">0</span></td><td>RY: <span id="ry">0</span></td></tr>
      <tr><td>L2: <span id="l2">0</span></td><td>R2: <span id="r2">0</span></td></tr>
    </table>
  </div>

  <div class="grid">
     <div id="btn0" class="btn">Cross</div>
     <div id="btn1" class="btn">Circle</div>
     <div id="btn2" class="btn">Square</div>
     <div id="btn3" class="btn">Tri</div>
     <div id="btn4" class="btn">L1</div>
     <div id="btn5" class="btn">R1</div>
     <div id="btn6" class="btn">L2</div>
     <div id="btn7" class="btn">R2</div>
     <div id="btn8" class="btn">Share</div>
     <div id="btn9" class="btn">Opt</div>
     <div id="btn10" class="btn">L3</div>
     <div id="btn11" class="btn">R3</div>
     <div id="btn12" class="btn">Up</div>
     <div id="btn13" class="btn">Down</div>
     <div id="btn14" class="btn">Left</div>
     <div id="btn15" class="btn">Right</div>
     <div id="btn16" class="btn" style="grid-column: span 4">PS Button</div>
  </div>

  <script>
    let interval = null;
    let busy = false; // Flow Control Flag

    window.addEventListener("gamepadconnected", (e) => {
      document.getElementById("status").innerText = "Active!";
      document.getElementById("status").classList.add("active");
      if (!interval) interval = setInterval(sendData, 50);
    });

    window.addEventListener("gamepaddisconnected", (e) => {
       document.getElementById("status").innerText = "Disconnected";
       document.getElementById("status").classList.remove("active");
       // V05 FIX: Keep the loop running to send Stop commands (zeros)
    });

    function sendData() {
      const gp = navigator.getGamepads()[0];
      
      let lx=0, ly=0, rx=0, ry=0, l2=0, r2=0, mask=0;

      // If Gamepad exists, read real values. 
      // If NOT (disconnected), these variables stay 0 (Safety Stop).
      if (gp) {
        // 1. Axes
        lx = gp.axes[0];
        ly = -gp.axes[1]; 
        rx = gp.axes[2];
        ry = -gp.axes[3]; 
        
        if (Math.abs(lx) < 0.1) lx = 0;
        if (Math.abs(ly) < 0.1) ly = 0;
        if (Math.abs(rx) < 0.1) rx = 0;
        if (Math.abs(ry) < 0.1) ry = 0;

        l2 = gp.buttons[6].value;
        r2 = gp.buttons[7].value;

        // 2. Buttons
        for (let i = 0; i < gp.buttons.length; i++) {
            if (gp.buttons[i].pressed) mask += (1 << i);
        }
      }

      // Update UI (Shows Real Data or Safe Zeros)
      document.getElementById("lx").innerText = lx.toFixed(1);
      document.getElementById("rx").innerText = rx.toFixed(1);
      document.getElementById("ly").innerText = ly.toFixed(1);
      document.getElementById("ry").innerText = ry.toFixed(1);
      document.getElementById("l2").innerText = l2.toFixed(1);
      document.getElementById("r2").innerText = r2.toFixed(1);
      
      // Update Button UI
      const totalButtons = 17; 
      for (let i = 0; i < totalButtons; i++) {
          let btnEl = document.getElementById("btn" + i);
          if (btnEl) {
              let pressed = (mask >> i) & 1;
              if (pressed) btnEl.classList.add("pressed");
              else btnEl.classList.remove("pressed");
          }
      }

      if (busy) return;
      busy = true; 

      // V05 FIX: Restore AbortController (50ms timeout)
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 50);
      
      fetch(`/update?ax=${lx.toFixed(2)},${ly.toFixed(2)},${rx.toFixed(2)},${ry.toFixed(2)}&tr=${l2.toFixed(2)},${r2.toFixed(2)}&mk=${mask}&z=${Date.now()}`, { signal: controller.signal })
        .then(response => { 
            clearTimeout(timeoutId);
            busy = false; 
        }) 
        .catch(e => { 
            // If it times out or fails, clear busy so we try again next loop
            busy = false; 
        });      
    }
  </script>
</body>
</html>